<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Math Practice</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="icon" type="image/svg+xml" href="/static/icon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #0ea5e9;
      --bg-2: #6366f1;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #0ea5e9;
      --primary-2: #22d3ee;
      --success: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --card-bg: rgba(255, 255, 255, 0.16);
      --card-border: rgba(255, 255, 255, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: linear-gradient(120deg, var(--bg-1), var(--bg-2));
      background-size: 200% 200%;
      animation: bgMove 12s ease infinite;
      padding: 24px;
    }

    @keyframes bgMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      width: min(880px, 100%);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 24px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 20px 60px rgba(2, 6, 23, 0.25);
      padding: 28px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 44px;
      height: 44px;
      display: grid;
      place-items: center;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: white;
      font-size: 24px;
      box-shadow: 0 10px 24px rgba(14, 165, 233, 0.35);
    }

    h1 {
      font-size: 1.6rem;
      margin: 0;
    }
    .subtitle { color: var(--muted); margin-top: 6px; font-size: .95rem; }

    .panel {
      margin-top: 12px;
      background: rgba(255,255,255,0.24);
      border: 1px solid rgba(255,255,255,0.35);
      border-radius: 18px;
      padding: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }

    .card-btn {
      position: relative;
      border: 0;
      border-radius: 16px;
      padding: 22px 18px;
      cursor: pointer;
      color: white;
      text-align: left;
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.35);
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
      overflow: hidden;
    }
    .card-btn .title { font-weight: 700; font-size: 1.15rem; letter-spacing: .2px; }
    .card-btn .desc { opacity: .85; margin-top: 6px; font-size: .9rem; }
    .card-btn .emj { position: absolute; right: 14px; bottom: 14px; font-size: 28px; filter: drop-shadow(0 6px 16px rgba(0,0,0,.2)); }
    .card-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 26px rgba(2, 6, 23, 0.25); background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.08)); }

    .choices { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
    .chip {
      border: 0; border-radius: 12px; padding: 14px 16px; cursor: pointer; color: white;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .chip:nth-child(2) { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .chip:nth-child(3) { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .chip:hover { transform: translateY(-2px); box-shadow: 0 10px 18px rgba(0,0,0,.18); }

    .back {
      appearance: none; border: 0; background: transparent; color: white; cursor: pointer;
      padding: 8px 12px; border-radius: 10px; display: inline-flex; align-items: center; gap: 8px;
      transition: background .2s ease;
    }
    .back:hover { background: rgba(255,255,255,0.12); }

    /* Problem */
    .progress { height: 10px; background: rgba(255,255,255,0.26); border-radius: 999px; overflow: hidden; }
    .progress > .bar { height: 100%; width: 0; background: linear-gradient(90deg, var(--success), #10b981); transition: width .25s ease; }
    .meta { color: white; opacity: .9; margin: 10px 0 18px; }

    .problem-card {
      background: rgba(255,255,255,0.24);
      border: 1px solid rgba(255,255,255,0.35);
      border-radius: 16px;
      padding: 24px;
    }
    .equation { font-weight: 700; font-size: clamp(2rem, 6vw, 3rem); color: white; text-shadow: 0 4px 18px rgba(0,0,0,.25); }

    .answer-row { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: 16px; }
    .input {
      width: 160px; padding: 14px 16px; font-size: 1.2rem; text-align: center; color: var(--text);
      background: white; border: 2px solid transparent; border-radius: 12px;
      outline: none; transition: border-color .2s ease, transform .2s ease;
    }
    .input:focus { border-color: var(--primary); transform: translateY(-1px); }

    .btn-primary {
      border: 0; border-radius: 12px; padding: 14px 18px; cursor: pointer; color: white; font-weight: 600;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 10px 22px rgba(14,165,233,.35);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 26px rgba(14,165,233,.45); }

    .feedback { min-height: 22px; font-size: .95rem; margin-top: 8px; }
    .ok { color: #dcfce7; }
    .bad { color: #fee2e2; }

    .shake { animation: shake .3s ease; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(6px); } 75% { transform: translateX(-6px); } }

    /* Congrats */
    .congrats {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white; border-radius: 18px; padding: 28px; text-align: center;
      box-shadow: 0 18px 44px rgba(22,163,74,.35);
    }
    .congrats h2 { margin: 0 0 6px; font-size: 2rem; }
    .congrats p { margin: 0 0 16px; opacity: .95; }
    .ghost { background: white; color: #16a34a; border: 0; padding: 12px 16px; border-radius: 12px; cursor: pointer; }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">üßÆ</div>
        <div>
          <h1>Math</h1>
          <div class="subtitle">Practice arithmetic: addition, subtraction, multiplication, and division</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="back hidden" id="back-btn" onclick="handleBack()">‚Üê Back</button>
        <button class="ghost" id="install-btn" style="display:none;">Install app</button>
      </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
    <section id="main-menu" class="panel">
      <div class="grid">
        <button class="card-btn" onclick="selectOperation('addition')">
          <div class="title">Addition</div>
          <div class="desc">Add numbers and build speed</div>
          <div class="emj">‚ûï</div>
        </button>
        <button class="card-btn" onclick="selectOperation('subtraction')">
          <div class="title">Subtraction</div>
          <div class="desc">Train accuracy and attention</div>
          <div class="emj">‚ûñ</div>
        </button>
        <button class="card-btn" onclick="selectOperation('multiplication')">
          <div class="title">Multiplication</div>
          <div class="desc">Mental math and times tables</div>
          <div class="emj">‚úñÔ∏è</div>
        </button>
        <button class="card-btn" onclick="selectOperation('division')">
          <div class="title">Division</div>
          <div class="desc">Divide evenly with whole-number answers</div>
          <div class="emj">‚ûó</div>
        </button>
        <button class="card-btn" onclick="selectOperation('complex')">
          <div class="title">Complex</div>
          <div class="desc">Mixed operations and order of operations</div>
          <div class="emj">üî¢</div>
        </button>
      </div>
    </section>

    <!-- –í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
    <section id="difficulty-menu" class="panel hidden">
      <div class="choices">
        <button class="chip" onclick="selectDifficulty('easy')">üü¢ Easy</button>
        <button class="chip" onclick="selectDifficulty('medium')">üü° Medium</button>
        <button class="chip" onclick="selectDifficulty('hard')">üî¥ Hard</button>
      </div>
    </section>

    <!-- –ë–ª–æ–∫ –∑–∞–¥–∞—á -->
    <section id="math-problem" class="panel hidden">
      <div class="progress"><div id="progress-bar" class="bar"></div></div>
      <div id="progress-text" class="meta">Problem 1 of 10</div>
      <div class="problem-card">
        <div id="problem-text" class="equation">2 + 3 = ?</div>
        <div class="answer-row">
          <input id="answer-input" type="number" class="input" placeholder="Answer" inputmode="numeric" />
          <button class="btn-primary" onclick="checkAnswer()">Check</button>
        </div>
        <div id="feedback" class="feedback"></div>
      </div>
    </section>

    <!-- –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <section id="congratulations" class="panel hidden">
      <div class="congrats">
        <h2>üéâ Great job!</h2>
        <p id="summary-line">You solved all 10 problems.</p>
        <div id="details-line" class="meta" style="margin:0 0 16px"></div>
        <button class="ghost" onclick="showMainMenu()">Try again</button>
      </div>
    </section>
  </div>

  <script>
    let currentOperation = '';
    let currentDifficulty = '';
    let currentProblemIndex = 0;
    let problems = [];

    function handleBack() {
      if (!document.getElementById('difficulty-menu').classList.contains('hidden')) {
        showMainMenu();
      } else if (!document.getElementById('math-problem').classList.contains('hidden')) {
        showDifficultyMenu();
      }
    }

    function selectOperation(operation) {
      currentOperation = operation;
      document.getElementById('main-menu').classList.add('hidden');
      document.getElementById('difficulty-menu').classList.remove('hidden');
      document.getElementById('math-problem').classList.add('hidden');
      document.getElementById('congratulations').classList.add('hidden');
      document.getElementById('back-btn').classList.remove('hidden');
    }

    function selectDifficulty(difficulty) {
      currentDifficulty = difficulty;
      generateProblems();
      showMathProblem();
    }

    function generateProblems() {
      problems = [];
      currentProblemIndex = 0;

      for (let i = 0; i < 10; i++) {
        let problem;
        let answer;

        switch (currentOperation) {
          case 'addition': {
            const ranges = {
              easy: [1, 20],
              medium: [10, 110],
              hard: [100, 1100]
            }[currentDifficulty];
            const a = randInt(ranges[0], ranges[1]);
            const b = randInt(ranges[0], ranges[1]);
            problem = `${a} + ${b} = ?`;
            answer = a + b;
            break;
          }
          case 'subtraction': {
            const ranges = {
              easy: [10, 30],
              medium: [50, 250],
              hard: [500, 2500]
            }[currentDifficulty];
            const a = randInt(ranges[0], ranges[1]);
            const b = randInt(ranges[0] / 2, a - 1);
            problem = `${a} - ${b} = ?`;
            answer = a - b;
            break;
          }
          case 'multiplication': {
            const ranges = {
              easy: [1, 10],
              medium: [5, 25],
              hard: [10, 60]
            }[currentDifficulty];
            const a = randInt(ranges[0], ranges[1]);
            const b = randInt(ranges[0], ranges[1]);
            problem = `${a} √ó ${b} = ?`;
            answer = a * b;
            break;
          }
          case 'division': {
            const bRange = { easy: [1, 10], medium: [5, 25], hard: [10, 60] }[currentDifficulty];
            const divisor = randInt(bRange[0], bRange[1]);
            const correctAnswer = randInt(bRange[0], bRange[1]);
            const dividend = divisor * correctAnswer; // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ü–µ–ª—ã–π –æ—Ç–≤–µ—Ç
            problem = `${dividend} √∑ ${divisor} = ?`;
            answer = correctAnswer;
            break;
          }
          case 'complex': {
            if (currentDifficulty === 'easy') {
              let a, b, c, attempts = 0;
              do {
                c = randInt(2, 10);
                let res = randInt(2, 20);
                a = randInt(1, 30);
                b = res * c - a;
                attempts++;
              } while ((a + b) % c !== 0 || b < 1 || attempts > 100);
              problem = `(${a} + ${b}) √∑ ${c} = ?`;
              answer = (a + b) / c;
            } else if (currentDifficulty === 'medium') {
              let a, b, c, d, e, attempts = 0;
              do {
                e = randInt(2, 8);
                let res = randInt(2, 20);
                c = randInt(10, 40);
                d = randInt(2, c - 1);
                let denominator = c - d;
                b = randInt(1, 40);
                a = res * denominator * e + b;
                attempts++;
              } while (((a - b) % (c - d) !== 0) || (c - d) === 0 || attempts > 100);
              problem = `(${a} - ${b}) √∑ (${c} - ${d}) √ó ${e} = ?`;
              answer = ((a - b) / (c - d)) * e;
            } else {
              let a, b, c, d, e, attempts = 0;
              do {
                c = randInt(2, 10);
                let res = randInt(2, 20);
                a = randInt(10, 100);
                b = res * c - a;
                d = randInt(20, 60);
                e = randInt(5, d - 1);
                attempts++;
              } while (((a + b) % c !== 0) || (d - e) <= 0 || attempts > 100);
              problem = `((${a} + ${b}) √∑ ${c}) √ó (${d} - ${e}) = ?`;
              answer = ((a + b) / c) * (d - e);
            }
            answer = Math.round(answer); // –≤—Å–µ–≥–¥–∞ —Ü–µ–ª–æ–µ
            break;
          }
        }

        problems.push({ problem, answer, attempts: 0, solved: false, firstTryCorrect: null });
      }
    }

    function showMathProblem() {
      document.getElementById('main-menu').classList.add('hidden');
      document.getElementById('difficulty-menu').classList.add('hidden');
      document.getElementById('math-problem').classList.remove('hidden');
      document.getElementById('congratulations').classList.add('hidden');
      document.getElementById('back-btn').classList.remove('hidden');
      document.getElementById('feedback').textContent = '';
      displayCurrentProblem();
    }

    function displayCurrentProblem() {
      const { problem } = problems[currentProblemIndex];
      document.getElementById('problem-text').textContent = problem;
      document.getElementById('answer-input').value = '';
      document.getElementById('answer-input').focus();

      const progress = ((currentProblemIndex + 1) / 10) * 100;
      document.getElementById('progress-bar').style.width = progress + '%';
      document.getElementById('progress-text').textContent = `Problem ${currentProblemIndex + 1} of 10`;
    }

    function checkAnswer() {
      const input = document.getElementById('answer-input');
      const feedback = document.getElementById('feedback');
      const userAnswer = Number(input.value);
      const current = problems[currentProblemIndex];
      current.attempts += 1;

      if (Number.isNaN(userAnswer)) {
        feedback.textContent = 'Enter a number';
        feedback.className = 'feedback bad';
        input.classList.remove('shake');
        void input.offsetWidth; // restart animation
        input.classList.add('shake');
        return;
      }

      if (userAnswer === current.answer) {
        feedback.textContent = 'Correct!';
        feedback.className = 'feedback ok';
        current.solved = true;
        current.firstTryCorrect = current.attempts === 1;
        setTimeout(() => {
          currentProblemIndex++;
          if (currentProblemIndex >= 10) {
            showCongratulations();
          } else {
            displayCurrentProblem();
            feedback.textContent = '';
          }
        }, 420);
      } else {
        feedback.textContent = 'Incorrect. Try again';
        feedback.className = 'feedback bad';
        input.classList.remove('shake');
        void input.offsetWidth; // restart animation
        input.classList.add('shake');
        input.focus();
        input.select();
      }
    }

    function showCongratulations() {
      document.getElementById('main-menu').classList.add('hidden');
      document.getElementById('difficulty-menu').classList.add('hidden');
      document.getElementById('math-problem').classList.add('hidden');
      document.getElementById('congratulations').classList.remove('hidden');
      document.getElementById('back-btn').classList.add('hidden');

      const firstTry = problems.filter(p => p.firstTryCorrect === true).length;
      const notFirst = problems
        .map((p, i) => ({ idx: i + 1, first: p.firstTryCorrect }))
        .filter(x => x.first === false)
        .map(x => x.idx);

      const summary = `First-try correct: ${firstTry} of 10`;
      const details = notFirst.length
        ? `Not on first try: problems # ${notFirst.join(', ')}`
        : 'All solved on the first try! Excellent!';

      document.getElementById('summary-line').textContent = summary;
      document.getElementById('details-line').textContent = details;
    }

    function showDifficultyMenu() {
      document.getElementById('main-menu').classList.add('hidden');
      document.getElementById('difficulty-menu').classList.remove('hidden');
      document.getElementById('math-problem').classList.add('hidden');
      document.getElementById('congratulations').classList.add('hidden');
      document.getElementById('back-btn').classList.remove('hidden');
    }

    function showMainMenu() {
      document.getElementById('main-menu').classList.remove('hidden');
      document.getElementById('difficulty-menu').classList.add('hidden');
      document.getElementById('math-problem').classList.add('hidden');
      document.getElementById('congratulations').classList.add('hidden');
      document.getElementById('back-btn').classList.add('hidden');
      currentOperation = '';
      currentDifficulty = '';
      currentProblemIndex = 0;
      problems = [];
    }

    function randInt(min, max) { // [min, max]
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    document.getElementById('answer-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkAnswer();
    });

    // PWA: service worker + install prompt
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').catch(() => {});
    }
    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });
    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        installBtn.style.display = 'none';
      }
      deferredPrompt = null;
    });
  </script>
</body>
</html>
